<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .navbar-custom {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .logo-header {
        height: 50px;
      }
      .search-container {
        max-width: 300px;
      }
      .tabla-datos {
        font-size: 0.9rem;
      }
      .btn-tab {
        padding: 0.25rem 0.5rem;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }
      .tab.active {
        border-color: #007bff;
        color: #007bff;
        font-weight: 500;
      }

      .table-container {
        display: none;
      }
      .table-container.active {
        display: block;
      }

      [data-motivo-container] {
        transition: opacity 0.3s ease;
      }
    </style>
  </head>
  <body>
    {% if session["rol"] == "Administrador" %}
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
      <div class="container-fluid">
        <img
          src="../../static/img/LogoKliiker.png"
          class="logo-header me-3"
          alt="Logo Kliiker"
        />
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="{{url_for('mostrar_tablas.mostrar_tabla')}}">Gestión</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{url_for('estadisticas.mostrar_estadisticas')}}"
                >Estadísticas</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Administrativo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{url_for('mostrar_asesores_tables.mostrar_asesores')}}"
                >Asesor</a
              >
            </li>
          </ul>
          <span class="navbar-text me-3">Hola {{session["usuario"]}} ({{session["rol"]}})</span>
          <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger"
            >Cerrar sesión</a
          >
        </div>
      </div>
    </nav>
    {% endif %}
    {% if session["rol"] == "Asesor" %}
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
      <div class="container-fluid">
        <img
          src="../../static/img/LogoKliiker.png"
          class="logo-header me-3"
          alt="Logo Kliiker"
        />
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="{{url_for('mostrar_tablas.mostrar_tabla')}}">Gestión</a>
            </li>
          </ul>
          <span class="navbar-text me-3">Hola {{session["usuario"]}}</span>
          <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger"
            >Cerrar sesión</a
          >
        </div>
      </div>
    </nav>
    {% endif %}
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="search-container">
          <input
            type="search"
            id="searchInput"
            class="form-control"
            placeholder="Buscar..."
          />
        </div>
        <img
          src="../../static/img/LogoAndes.png"
          class="logo-header"
          alt="Logo Andes"
        />
      </div>

      <div class="tabs">
        <button class="tab active" onclick="mostrarTabla('gestion')">
          Gestión
        </button>
        <button class="tab" onclick="mostrarTabla('historial')">
          Historial
        </button>
      </div>

      <!-- Tabla Gestión -->
      <div class="table-container active" id="gestionTable">
        <table class="table table-hover tabla-datos">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Celular</th>
              <th>Código</th>
              <th>Id Kliiker</th>
              <th>Tipificación</th>
              <th>Gestiones</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in datos %}
            <tr>
              <td>
                <button
                  class="btn btn-link btn-tab text-decoration-none"
                  data-bs-toggle="modal"
                  data-bs-target="#detalleModal"
                  data-idgestion="{{ fila.idGestion }}"
                  data-id_estado="{{ fila.id_estado }}"
                  data-nombre="{{ fila.nombre }}"
                  data-apellido="{{ fila.apellido }}"
                  data-celular="{{ fila.celular }}"
                  data-motivonoint="{{ fila.motivoNoInteres }}"
                  data-tipificacion="{{ fila.tipGestion }}"
                  data-canal="{{ fila.canal }}"
                  data-fechaproxima="{{ fila.fecha_proxima_gestion }}"
                  data-descripcion="{{ fila.comentario }}"
                  data-tipogestion="{{ fila.tipoGestion }}"
                >
                  {{ fila.nombre }}
                </button>
              </td>
              <td>{{ fila.apellido }}</td>
              <td>{{ fila.celular }}</td>
              <td>{{ 'Sí' if fila.nivel else 'No'}}</td>
              <td>{{ fila.idKliiker }}</td>
              <td>{{ fila.tipGestion }}</td>
              <td>{{ fila.cantidad_gestiones }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Tabla Historial -->
      <div class="table-container" id="historialTable">
        <table class="table table-hover tabla-datos">
            <thead class="table-light">
                <tr>
                    <th>Id Kliiker</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Celular</th>
                    <th>Nivel</th>
                    <th>Fecha</th>
                    <th>Canal</th>
                    <th>Tipificación</th>
                    <th>Estado</th>
                    <th>Comentario</th>
                    <th>Asesor</th>
                </tr>
            </thead>
            <tbody>
                {% for historial in datos_historial %}
                <tr>
                    <td>{{ historial.idKliiker }}</td>
                    <td>{{ historial.nombre }}</td>
                    <td>{{ historial.apellido }}</td>
                    <td>{{ historial.celular }}</td>
                    <td>{{ historial.nivel }}</td>
                    <td>{{ historial.fecha }}</td>
                    <td>{{ historial.canal }}</td>
                    <td>{{ historial.tipificacion }}</td>
                    <td>{{ historial.id_estado }}</td>
                    <td>{{ historial.comentario }}</td>
                    <td>{{ historial.asesor }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="detalleModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Gestión de Cliente</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form
            method="POST"
            action="{{ url_for('actualizar_gestion_modal.actualizar_gestion')}}"
          >
            <div class="modal-body">
              <input type="hidden" name="id_gestion" id="modalIdGestion" />

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label">ID Llamada</label>
                  <input
                    type="text"
                    class="form-control"
                    name="id_llamada"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <select class="form-select" name="id_estado" required>
                    <option value="">Seleccione</option>
                    <option value="1">Día 1</option>
                    <option value="2">Día 2</option>
                    <option value="3">Día 3</option>
                  </select>
                </div>
              </div>

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label">Tipificación</label>
                  <select class="form-select" name="tipificacion" required>
                    <option value="">Seleccione</option>
                    <option value="No contesta">No contesta</option>
                    <option value="Buzón de voz">Buzón de voz</option>
                    <option value="Información general">
                      Información general
                    </option>
                    <option value="Sin interes">Sin interés</option>
                    <option value="Equivocado">Equivocado</option>
                    <option value="Registro exitoso">Registro exitoso</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Canal</label>
                  <select class="form-select" name="canal" required>
                    <option value="">Seleccione</option>
                    <option value="Whatsapp">Whatsapp</option>
                    <option value="Via telefonica">Vía telefónica</option>
                  </select>
                </div>
              </div>

              <div
                class="row g-3 mb-4"
                data-motivo-container
                style="display: none"
              >
                <div class="col-md-12">
                  <label class="form-label">Motivo no interés</label>
                  <select class="form-select" name="motivo_no_interes">
                    <option value="">Seleccione</option>
                    <option value="Consiguio trabajo">Consiguió trabajo</option>
                    <option value="Precio alto">Precio alto</option>
                    <option value="Confusión oferta de empleo">
                      Confusión oferta de empleo
                    </option>
                    <option value="Pensaba que era diferente">
                      Pensaba que era diferente
                    </option>
                    <option value="Estafa">Estafa</option>
                  </select>
                </div>
              </div>

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label">Tipo gestión</label>
                  <select class="form-select" name="tipoGestion" required>
                    <option value="">Seleccione</option>
                    <option value="Entrada">Entrada</option>
                    <option value="Salida">Salida</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Fecha próxima llamada</label>
                  <input
                    type="date"
                    class="form-control"
                    name="fecha_proxima_gestion"
                  />
                </div>
              </div>

              <div class="col-md-12">
                <label class="form-label">Descripción</label>
                <input
                  type="text"
                  class="form-control"
                  name="Descripcion"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">
                Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Control de pestañas
      function mostrarTabla(tipo) {
        document
          .querySelectorAll(".table-container")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));

        document.getElementById(`${tipo}Table`).classList.add("active");
        document
          .querySelector(`button[onclick="mostrarTabla('${tipo}')"]`)
          .classList.add("active");
      }

      // Búsqueda optimizada
      document
        .getElementById("searchInput")
        .addEventListener("input", function (e) {
          const filter = e.target.value
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase();
          const activeTable = document.querySelector(
            ".table-container.active table"
          );

          Array.from(activeTable.querySelectorAll("tbody tr")).forEach(
            (row) => {
              const text = Array.from(row.children)
                .map((cell) =>
                  cell.textContent
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toUpperCase()
                )
                .join(" ");
              row.style.display = text.includes(filter) ? "" : "none";
            }
          );
        });

      // Control del Modal
      document
        .getElementById("detalleModal")
        .addEventListener("show.bs.modal", function (e) {
          const button = e.relatedTarget;
          const modal = this;

          // Mapeo de datos
          const fieldMap = {
            "#modalIdGestion": "idgestion",
            'input[name="id_llamada"]': "idllamada",
            'select[name="id_estado"]': "id_estado",
            'select[name="tipificacion"]': "tipificacion",
            'select[name="canal"]': "canal",
            'select[name="tipoGestion"]': "tipogestion",
            'select[name="motivo_no_interes"]': "motivonoint",
            'input[name="fecha_proxima_gestion"]': "fechaproxima",
            'input[name="Descripcion"]': "descripcion",
          };

          // Rellenar campos
          Object.entries(fieldMap).forEach(([selector, dataAttr]) => {
            const element = modal.querySelector(selector);
            if (element) {
              element.value = button.dataset[dataAttr] || "";
            }
          });

          // Control de visibilidad del motivo
          const motivoSection = modal.querySelector("[data-motivo-container]");
          const toggleVisibility = () => {
            const mostrar =
              modal.querySelector('select[name="tipificacion"]').value ===
              "Sin interes";
            motivoSection.style.display = mostrar ? "block" : "none";
            if (!mostrar) motivoSection.querySelector("select").value = "";
          };

          toggleVisibility();
          modal
            .querySelector('select[name="tipificacion"]')
            .addEventListener("change", toggleVisibility);
        });
    </script>
  </body>
</html>
