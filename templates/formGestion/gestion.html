<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .navbar-custom {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .logo-header {
        height: 50px;
      }
      .search-container {
        max-width: 300px;
      }
      .tabla-datos {
        font-size: 0.9rem;
      }
      .btn-tab {
        padding: 0.25rem 0.5rem;
      }
      /* Pestañas */
      .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            border: 1px solid #ccc;
            cursor: pointer;
            background: none;
            border: none;
        }
        .tab.active {
            background-color: #007bff;
            color: white;
        }
        #historialTable {
            display: none;
        }
    </style>
  </head>
  <body>
    <!-- Barra de navegación -->
     
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
      <div class="container-fluid">
        <img
          src="../../static/img/LogoKliiker.png"
          class="logo-header me-3"
          alt="Logo Kliiker"
        />

        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="#">Gestión</a>
            </li>
              <li class="nav-item">
              <a class="nav-link" href="/estadisticas/estadisticas.html">Estadísticas</a>
            </li>
          
            <li class="nav-item">
              <a class="nav-link" href="#">Administrativo</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="{{url_for('asesores_tables.index')}}">Asesor</a></li>
          </ul>
          <span class="navbar-text me-3">Hola {{session["usuario"]}}</span>
          <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger"
            >Cerrar sesión</a
          >
        </div>
      </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="search-container">
          <input type="search" id="searchInput" class="form-control" placeholder="Buscar..." />
        </div>
        <img
          src="../../static/img/LogoAndes.png"
          class="logo-header"
          alt="Logo Andes"
        />
      </div>

      <!-- Pestañas -->
      <div class="tabs">
        <button class="tab active" onclick="mostrarTabla('gestion')">Gestión</button>
        <button class="tab" onclick="mostrarTabla('historial')">Historial</button>
      </div>
      <!-- ----------------------------------------------------------------------- -->
      <!--                              Tabla Gestion                              -->
      <!-- ----------------------------------------------------------------------- -->
      <div class="table-responsive" id="gestionTable">
        <table class="table table-hover tabla-datos" id="gestionTableBuscar">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Celular</th>
              <th>Código</th>
              <th>Id Kliiker</th>
              <th>Tipificación</th>
              <th>Gestiones</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in datos %}
            <tr>
              <td>
                <button
                class="btn btn-link btn-tab text-decoration-none"
                data-bs-toggle="modal"
                data-bs-target="#detalleModal"
                data-idgestion="{{ fila.idGestion }}"
                data-estado="{{ fila.estado }}"
                data-nombre="{{ fila.nombre }}"
                data-apellido="{{ fila.apellido }}"
                data-celular="{{ fila.celular }}"
                data-motivoNoInt="{{ fila.motivoNoInteres }}"
                >
                {{ fila.nombre }}
                </button>
              </td>
              <td>{{ fila.apellido }}</td>
              <td>{{ fila.celular }}</td>
              <td>{{ 'Sí' if fila.nivel else 'No'}}</td>
              <td>{{ fila.idKliiker }}</td>
              <td>{{ fila.tipificacion }}</td>
              <td>{{ fila.cantidad_gestiones }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>


    <!-- -------------------------------- Modal -------------------------------- -->
    <div class="modal fade" id="detalleModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Gestión de Cliente</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form method="POST" action="{{ url_for('actualizar_gestion_modal.actualizar_gestion')}}">
            <div class="modal-body">
              <input type="hidden" name="id_gestion" id="modalIdGestion">

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label">ID Llamada</label>
                  <input
                    type="text"
                    class="form-control"
                    name="id_llamada"
                    required
                  />
                </div>

                <div class="col-md-6">
                <label class="form-label">Estado</label>
                  <select class="form-select" name="estado" required>
                    <option value="">Seleccione</option>
                    <!-- <option value="Nuevos">Nuevos</option> -->
                    <option value="Llamada1">Llamada 1</option>
                    <option value="Llamada2">Llamada 2</option>
                    <option value="Llamada3">Llamada 3</option>
                    <option value="Llamada4">Llamada 4</option>
                    <!-- <option value="Descartados">Descartados</option> -->
                  </select>
                </div>
              </div>

              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label class="form-label">Tipificación</label>
                  <select class="form-select" name="tipificacion" required>
                    <option value="">Seleccione</option>
                    <option value="No contesta">No contesta</option>
                    <option value="Buzón de voz">Buzón de voz</option>
                    <option value="Información general">
                      Información general
                    </option>
                    <option value="Sin interes">Sin interés</option>
                    <option value="Equivocado">Equivocado</option>
                    <option value="Registro exitoso">Registro exitoso</option>
                  </select>
                </div>

                <div class="col-md-5">
                  <label class="form-label">Canal</label>
                  <select class="form-select" name="canal" required>
                    <option value="">Seleccione</option>
                    <option value="Whatsapp">Whatsapp</option>
                    <option value="Via telefonica">Vía telefónica</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Tipo gestión</label>
                <select class="form-select" name="tipoGestion" required>
                  <option value="">Seleccione</option>
                  <option value="Whatsapp">Entrada</option>
                  <option value="Via telefonica">Salida</option>
                </select>
              </div>
            </div>

                <div class="row g-3 mb-4" data-motivo-container style="display: none;">
                  <div class="col-md-7">
                      <label class="form-label">Motivo no interés</label>
                      <select class="form-select" name="motivo_no_interes">
                          <option value="">Seleccione</option>
                          <option value="Consiguio trabajo">Consiguió trabajo</option>
                          <option value="Precio alto">Precio alto</option>
                          <option value="Confusión oferta de empleo">
                              Confusión oferta de empleo
                          </option>
                          <option value="Pensaba que era diferente">
                              Pensaba que era diferente
                          </option>
                          <option value="Estafa">Estafa</option>
                      </select>
                  </div>
              </div>

                <div class="col-md-6">
                  <label class="form-label">Fecha próxima llamada</label>
                  <input
                    type="date"
                    class="form-control"
                    name="fecha_proxima_gestion"
                  />
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Descripción</label>
                <input
                  type="text"
                  class="form-control"
                  name="Descripcion"
                  required
                />
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">
                Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ----------------------------------------------------------------------- -->
    <!--                             Tabla Historial                             -->
    <!-- ----------------------------------------------------------------------- -->
    <div class="table-responsive" id="historialTable">
      <!-- En tu archivo gestion.html -->
    <table class="table table-hover tabla-datos" id="historiaTableBuscar" >
      <thead class="table-light">
              <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Celular</th>
                  <th>Nivel</th>
                  <th>Id Kliiker</th>
                  <th>Fecha</th>
                  <th>Tipificación</th>
                  <th>Estado</th>
                  <th>Canal</th>
                  <th>Tipo gestion</th>
                  <th>Comentario</th>
                  <th>Asesor</th>
              </tr>
          </thead>
          <tbody>
              {% for fila in datos %}
              <tr>
                  <td>{{ fila.nombre }}</td>
                  <td>{{ fila.apellido }}</td>
                  <td>{{ fila.celular }}</td>
                  <td>{{ 'Sí' if fila.nivel else 'No'}}</td>
                  <td>{{ fila.idKliiker }}</td>
                  <td>{{ fila.fecha }}</td>
                  <td>{{ fila.tipificacion }}</td>
                  <td>{{ fila.estado }}</td>
                  <td>{{ fila.canal }}</td>
                  <td>{{ fila.tipoGestion }}</td>
                  <td>{{ fila.comentario }}</td>
                  <td>{{ fila.asesor }}</td>
              </tr>
              {% endfor %}
          </tbody>
        </table>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Script para manejar los datos del modal - Versión Mejorada
document.getElementById("detalleModal").addEventListener("show.bs.modal", function(event) {
    const button = event.relatedTarget;
    const modal = this;
    
    // Mapeo completo de datos
    const fieldMappings = {
        '#modalIdGestion': 'idgestion',
        'input[name="id_llamada"]': 'idllamada',
        'select[name="estado"]': 'estado',
        'select[name="tipificacion"]': 'tipificacion',
        'select[name="canal"]': 'canal',
        'select[name="motivo_no_interes"]': 'motivo',
        'input[name="fecha_proxima_gestion"]': 'fechaproxima',
        'input[name="Descripcion"]': 'descripcion'
    };

    // Poblar todos los campos
    Object.entries(fieldMappings).forEach(([selector, dataField]) => {
        const element = modal.querySelector(selector);
        const value = button.dataset[dataField];
        
        if (element) {
            if (element.tagName === 'SELECT') {
                Array.from(element.options).forEach(option => {
                    option.selected = option.value === value;
                });
            } else {
                element.value = value || '';
            }
        } 
    });
});
        /*Función para las tablas gestión y historial*/
        function mostrarTabla(tipo) {
        const gestionTab = document.querySelector('.tab:nth-child(1)');
        const historialTab = document.querySelector('.tab:nth-child(2)');
        const gestionTable = document.getElementById('gestionTable');
        const historialTable = document.getElementById('historialTable'); 

        if (tipo === 'gestion') {
            gestionTab.classList.add('active');
            historialTab.classList.remove('active');
            gestionTable.style.display = 'block'; 
            historialTable.style.display = 'none';
        } else {
            historialTab.classList.add('active');
            gestionTab.classList.remove('active');
            historialTable.style.display = 'block'; 
            gestionTable.style.display = 'none';
        }
    }

// ------------------------------------------------------------------------------------
    // Buscar
    document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM cargado"); // Verifica que el DOM esté listo

    const input = document.getElementById("searchInput");
    const gestionTable = document.getElementById("gestionTable");
    const historialTable = document.getElementById("historialTable");

    console.log("Campo de búsqueda:", input); // Verifica si el campo de búsqueda se encuentra
    console.log("Tablas:", gestionTable, historialTable); // Verifica si las tablas se encuentran

    if (!input || !gestionTable || !historialTable) {
        console.error("No se encontraron los elementos necesarios.");
        return;
    }

    // Función para normalizar texto (eliminar tildes y convertir a mayúsculas)
    function normalizarTexto(texto) {
        return texto
            .normalize("NFD") // Normaliza el texto a su forma descompuesta (NFD)
            .replace(/[\u0300-\u036f]/g, "") // Elimina los diacríticos (tildes)
            .toUpperCase(); // Convierte el texto a mayúsculas
    }

    // Función para buscar en una tabla específica
    function buscarEnTabla(table, filter) {
        const rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) { // Comienza desde 1 para omitir la cabecera
            const row = rows[i];
            const cells = row.getElementsByTagName("td");
            let mostrarFila = false;

            // Recorre todas las celdas de la fila
            for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];
                if (cell) {
                    const text = cell.textContent || cell.innerText;
                    const textoNormalizado = normalizarTexto(text);
                    const filtroNormalizado = normalizarTexto(filter);

                    if (textoNormalizado.includes(filtroNormalizado)) {
                        mostrarFila = true;
                        break; // Si alguna celda coincide, mostrar la fila
                    }
                }
            }

            // Muestra u oculta la fila según si coincide con la búsqueda
            if (mostrarFila) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        }
    }

    // Función principal para buscar en ambas tablas
    function buscarEnAmbasTablas() {
        const filter = input.value;

        // Buscar en la tabla de gestión
        buscarEnTabla(gestionTable, filter);

        // Buscar en la tabla de historial
        buscarEnTabla(historialTable, filter);
    }

    // Escuchar el evento "input" en el campo de búsqueda
    input.addEventListener("input", buscarEnAmbasTablas);
});
// --------------------------------------------------------------------------------------
   // Control de visibilidad del motivo de no interés
   document.getElementById('detalleModal').addEventListener('show.bs.modal', function() {
        const tipificacionSelect = this.querySelector('select[name="tipificacion"]');
        const motivoNoInteresContainer = this.querySelector('div[data-motivo-container]');
        
        // Función para controlar la visibilidad
        const toggleMotivoVisibility = () => {
            const mostrar = tipificacionSelect.value === 'Sin interes';
            motivoNoInteresContainer.style.display = mostrar ? 'block' : 'none';
            if (!mostrar) {
                motivoNoInteresContainer.querySelector('select').value = '';
            }
        };

        // Ejecutar al cargar el modal
        toggleMotivoVisibility();
        
        // Escuchar cambios en la tipificación
        tipificacionSelect.addEventListener('change', toggleMotivoVisibility);
    });
</script>
  </body>
</html>
